<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Set minimum date to today
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').setAttribute('min', today);
    });
    
    document.getElementById('pay-now-btn').addEventListener('click', function() {
        // Validate form
        const form = document.getElementById('registration-form');
        if (!form.checkValidity()) {
            const invalidFields = form.querySelectorAll(':invalid');
            invalidFields.forEach(field => {
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                field.focus();
            });
            alert('Please fill all required fields');
            return;
        }
        
        // Show loading indicator
        document.getElementById('loading-indicator').classList.add('active');
        document.getElementById('pay-now-btn').disabled = true;
        
        // Get form data
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const className = document.getElementById('class').options[document.getElementById('class').selectedIndex].text;
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').options[document.getElementById('time').selectedIndex].text;
        const topic = document.getElementById('topic').value || 'General JEE Preparation';
        
        // Format date for display
        const formattedDate = new Date(date).toLocaleDateString('en-IN', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Create Razorpay options
        const options = {
            key: 'rzp_test_1234567890', // Test key
            amount: 7000, // â‚¹70 in paise
            currency: 'INR',
            name: 'JEE Mentorship with Sagar & Sanjay',
            description: '45-minute mentorship session',
            image: 'https://via.placeholder.com/100x50?text=JEE+Logo',
            handler: function(response) {
                console.log('Payment successful!', response);
                // Hide loading indicator
                document.getElementById('loading-indicator').classList.remove('active');
                document.getElementById('pay-now-btn').disabled = false;
                
                // Redirect to confirmation page (skip Google Sheets for now)
                window.location.href = 'confirmation.html?' + 
                    'payment_id=' + response.razorpay_payment_id + 
                    '&name=' + encodeURIComponent(name) + 
                    '&date=' + encodeURIComponent(formattedDate) + 
                    '&time=' + encodeURIComponent(time);
            },
            prefill: {
                name: name,
                email: email,
                contact: phone
            },
            theme: {
                color: '#4361ee'
            },
            modal: {
                ondismiss: function() {
                    // Hide loading indicator
                    document.getElementById('loading-indicator').classList.remove('active');
                    document.getElementById('pay-now-btn').disabled = false;
                    alert('Payment cancelled. Please try again to book your session.');
                }
            }
        };
        
        // Open Razorpay checkout
        try {
            const rzp = new Razorpay(options);
            rzp.on('payment.failed', function(response) {
                console.log('Payment failed!', response);
                document.getElementById('loading-indicator').classList.remove('active');
                document.getElementById('pay-now-btn').disabled = false;
                alert('Payment failed. Please try again. Error: ' + response.error.description);
            });
            
            rzp.open();
        } catch (error) {
            console.error('Razorpay error:', error);
            document.getElementById('loading-indicator').classList.remove('active');
            document.getElementById('pay-now-btn').disabled = false;
            alert('There was an error initializing the payment. Please try again.');
        }
    });
</script>
